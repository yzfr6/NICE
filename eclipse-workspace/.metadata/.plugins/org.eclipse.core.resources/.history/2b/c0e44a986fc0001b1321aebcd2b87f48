package Algorithm;

import java.io.File;
import java.io.IOException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.ParseException;

import Database.BNFConnector;
import JSON.JSONGetter;

public class ConvertAlgorithm {

	public static void main (String [] args) throws IOException, ParseException, SQLException {
		
		File f = new File("/Users/nice/Developer/eclipse-workspace/NICE-PP/resources/algorithm_entities/algorithm.json");
		
		JSONObject algorithm = JSONGetter.loadJSONObject(f);
		
		Connection c = BNFConnector.getConnection().orElseThrow();
		
		c.setAutoCommit(false);
		c.prepareStatement("SET FOREIGN_KEY_CHECKS=0").execute();
		c.prepareStatement("truncate algorithm").executeUpdate();
		c.prepareStatement("truncate node").executeUpdate();
		c.prepareStatement("SET FOREIGN_KEY_CHECKS=1").execute();
		
		PreparedStatement ps = c.prepareStatement("insert into algorithm (name) values (?)");
		ps.setString(1, (String)algorithm.get("name"));
		ps.executeUpdate();
		
		
		
		JSONArray nodes = (JSONArray)algorithm.get("nodes");
		for (Object obj1 : nodes) {
			/*
			 * {
			"id": "1.1",
			"text": "HbA1c > 48 mmol/mol?",
			"node_type": "decision",
			"entities": {
				"single": {
					"type": "algorithm_observation_decision_1",
					"id": 1
				}
			}
		},
			 */
			JSONObject node = (JSONObject)obj1;
			String object_id = (String)node.get("id");
			String text = (String)node.get("text");
			String node_type = (String)node.get("node_type");
			
			PreparedStatement ps1 = c.prepareStatement("insert into node (object_id, text, type) values (?, ?, ?)", Statement.RETURN_GENERATED_KEYS);
			ps1.setString(1, object_id);
			ps1.setString(2, text);
			ps1.setString(3, node_type);
			ps1.executeUpdate();
			ResultSet rs1 = ps1.getGeneratedKeys();
			rs1.next();
			int node_id = rs1.getInt(1);
			
			
			JSONObject entites = (JSONObject)node.get("entities");
			
			if (entites.containsKey("single")) {
				
			} else if (entites.containsKey("and")) {
				
			} else if (entites.containsKey("or")) {
				
			}
			
		}
		
		
		c.commit();
		c.setAutoCommit(true);
		
		c.close();
		
		
	}
	
}
